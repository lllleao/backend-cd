name: Deploy to Oracle VM

on:
    push:
        tags:
            - 'deploy-*'

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Install dependencies
              run: npm ci

            - name: Run lint
              run: npm run lint

            - name: Obter IP pÃºblico do runner
              id: ip
              uses: haythem/public-ip@v1.2

            - name: Exibir IP no log
              run: |
                  echo "IPv4 do runner: ${{ steps.ip.outputs.ipv4 }}"
                  echo "IPv6 do runner: ${{ steps.ip.outputs.ipv6 }}"

            - name: Login no OCIR
              run: echo "${{ secrets.OCIR_TOKEN }}" | docker login gru.ocir.io -u "${{ secrets.OCIR_USERNAME }}" --password-stdin

            - name: Gerar .env para build
              run: |
                  echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
                  echo "ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}" >> .env

            - name: Build da imagem
              run: docker compose -f docker-compose.prod.yml build

            - name: Push da imagem
              run: docker compose -f docker-compose.prod.yml push

            - name: Deploy remoto via SSH
              uses: appleboy/ssh-action@v0.1.10
              with:
                  host: ${{ secrets.VM_HOST }}
                  username: ${{ secrets.VM_USER }}
                  key: ${{ secrets.SSH_KEY }}
                  script: |
                      docker login gru.ocir.io -u "${{ secrets.OCIR_USERNAME }}" --password "${{ secrets.OCIR_TOKEN }}"
                      cd /home/ubuntu/projeto/backend-cd
                      sudo docker compose -f docker-compose.prod.yml pull
                      sudo docker compose -f docker-compose.prod.yml up -d
